# Проектное задание: Data Engineering

Проект включает ETL-процессы для загрузки данных из CSV в PostgreSQL, расчет витрин данных, формирование отчетов (включая 101 форму) и устранение дефектов в витринах.

## Технологии
- PostgreSQL
- Python
- Pandas
- Psycopg2
- Логирование (logging)

## Основные задачи
1. ETL-процесс: Загрузка данных из CSV в PostgreSQL.
2. Расчет витрин: DM.DM_ACCOUNT_TURNOVER_F и DM.DM_ACCOUNT_BALANCE_F.
3. Формирование 101 формы: Отчет за январь 2018 года.
4. Экспорт/импорт данных: Выгрузка в CSV и загрузка обратно.
5. Устранение дефектов: Очистка дублей и исправление некорректных данных.

## Задание 1
В некотором банке внедрили новую frontend-систему для работы с клиентами, а так же обновили и саму базу данных. Большую часть данных успешно были перенесены из старых БД в одну новую централизованную БД.  Но в момент переключения со старой системы на новую возникли непредвиденные проблемы в ETL-процессе, небольшой период (конец 2017 начало 2018 года) так и остался в старой базе. Старую базу отключили, а не выгруженные данные сохранили в csv-файлы. Недавно банку потребовалось построить отчёт по 101 форме. Те данные что остались в csv-файлах тоже нужны. Загрузить их в новую БД не получиться из-за архитектурных и управленческих сложностей, нужно рассчитать витрину отдельно. Но для этого сначала нужно загрузить исходные данные из csv-файлов в детальный слой (DS) хранилища в СУБД PostgreSQL.

 

## Задача 1.1

Разработать ETL-процесс для загрузки «банковских» данных из csv-файлов в соответствующие таблицы СУБД PostgreSQL. Покрыть данный процесс логированием этапов работы и всевозможной дополнительной статистикой. Обратите внимание, что в разных файлах может быть разный формат даты, это необходимо учитывать при загрузке.

## Задача 1.2

После того как детальный слой «DS» успешно наполнен исходными данными из файлов – нужно рассчитать витрины данных в слое «DM»: витрину оборотов (DM.DM_ACCOUNT_TURNOVER_F) и витрину остатков (DM.DM_ACCOUNT_BALANCE_F).

## Задача 1.3

После того как в предыдущих заданиях вы загрузили необходимую информацию и рассчитали витрины с оборотами и остатками, необходимо произвести расчет 101 формы за январь 2018 года.
101 форма содержит информацию об остатках и оборотах за отчетный период, сгруппированных по балансовым счетам второго порядка. Необходимо создать процедуру расчета, которая должна иметь один входной параметр – отчетную дату (i_on_date). Отчетная дата – это первый день месяца, следующего за отчетным. В отчет должна попасть информация по всем счетам, действующим в отчетном периоде, группировка в отчете идет по балансовым счетам второго порядка (балансовый счет второго порядка – это первые 5 символов номера счета).

## Задача 1.4

Напишите скрипт, который позволит выгрузить данные из витрины «dm. dm _f101_round_f» в csv-файл, первой строкой должны быть наименования колонок таблицы.
Убедитесь, что данные выгружаются в корректном формате и напишите скрипт, который позволит импортировать их обратно в БД. Поменяйте пару значений в выгруженном csv-файле и загрузите его в копию таблицы 101-формы «dm. dm _f101_round_f_v2».

## Задание 2
После успешного формирования отчетов, к банку пришел заказчик данных и сообщил, что по имеющимся витринам имеются дефекты. Для того, чтобы заказчик был доволен и мог беспрепятственно пользовать витринами, необходимо оперативно устранить имеющиеся дефекты.

## Задача 2.1
Имеется витрина dm.client, в которой содержится различная информация по клиентам банка. Заказчик сообщил, что в таблице имеются дубли, которые нужно устранить.
Необходимо подготовить запрос, по которому можно обнаружить все дубли в витрине и удалить их.

## Задача 2.2
Имеется витрина dm.loan_holiday_info, которая содержит информацию по кредитным каникулам, сделке и продукте, который был предоставлен клиенту в рамках сделки. После проверки качества данных выявилась проблема отсутствия некоторого количества записей в источниках витрины для некоторых периодов эффективности строк.

Необходимо проанализировать витрину, актуальное состояние таблиц-источников витрины и определить, по каким датам эффективности (effective_from_date или effective_to_date) отсутствуют строки и определить, какой способ загрузки новых данных подойдет: полная перегрузка таблицы или загрузка части данных.

## Задача 2.3
Имеется витрина dm.account_balance_turnover, которая отражает изменение баланса счетов по дням. Заказчик очень требователен в части заполнения всех полей этой витрины, например суммы на начало и конец дня, наименование валюты. Во время проверки качества данных обнаружили, что у счетов иногда отличается account_out_sum - сумма на конец одного дня и account_in_sum - сумма на начало следующего.

### Необходимо:
1) Подготовить запрос, который определит корректное значение поля account_in_sum. Если значения полей account_in_sum одного дня и account_out_sum предыдущего дня отличаются, то корректным выбирается значение account_out_sum предыдущего дня.

2) Подготовить такой же запрос, только проблема теперь в том, что account_in_sum одного дня правильная, а account_out_sum предыдущего дня некорректна. Это означает, что если эти значения отличаются, то корректным значением для account_out_sum предыдущего дня выбирается значение account_in_sum текущего дня.

3) Подготовить запрос, который поправит данные в таблице rd.account_balance.

4) Написать процедуру для перезагрузки данных в витрину.
